id: llvm
version: 20.1.8
about: |
    A collection of modular and reusable compiler and toolchain technologies

build-dir: llvm-project-%{version}.src/llvm
build-type: cmake

pre-script: |-
    cd ../
    patch -Np1 -i 0012-libc-libc-abi-libunwind-disable-multiarch-locations.patch
    patch -Np1 -i 0017-clang-use-as-needed-by-default.patch
    patch -Np1 -i 0024-clang-link-libcxxabi-on-linux-when-using-libc.patch

configure: >-
    -DLLVM_ENABLE_FFI=ON
    -DCMAKE_BUILD_TYPE=Release
    -DLLVM_BUILD_LLVM_DYLIB=ON
    -DLLVM_LINK_LLVM_DYLIB=ON
    -DLLVM_ENABLE_RTTI=ON
    -DLLVM_TARGETS_TO_BUILD="host;AMDGPU;BPF"
    -DLLVM_ENABLE_PROJECTS='clang;clang-tools-extra;lld'
    -DLLVM_BINUTILS_INCDIR=/usr/include
    -DLLVM_INCLUDE_BENCHMARKS=OFF
    -DCLANG_DEFAULT_PIE_ON_LINUX=ON

post-script: |-
    cp %{build-dir}/bin/FileCheck %{install-root}/%{bindir}

depends:
    - components/glibc.yml
build-depends:
    - components/cmake.yml

sources:
    - https://github.com/llvm/llvm-project/releases/download/llvmorg-%{version}/llvm-project-%{version}.src.tar.xz
    - patches/llvm/0012-libc-libc-abi-libunwind-disable-multiarch-locations.patch
    - patches/llvm/0017-clang-use-as-needed-by-default.patch
    - patches/llvm/0024-clang-link-libcxxabi-on-linux-when-using-libc.patch
