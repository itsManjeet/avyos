name: Build And Release
on:
  push:
    branches:
      - main
    tags:
      - '*'
  pull_request:

jobs:
  build:
    if: github.event_name != 'pull_request'
    runs-on: self-hosted
    strategy:
      matrix:
       arch: [amd64]
    steps:
      - uses: actions/checkout@v5
      - name: Cleanup cache
        run: rm -rf _out

      - name: Fix autogen
        run: ./scripts/fix-autogen.sh

      - name: Build
        run: |
          GOARCH=${{matrix.arch}} \
            make -j$(nproc)
      
      - name: Compress Image
        run: |
          zstd -19 \
            _out/${{matrix.arch}}-linux-musl/images/avyos-${{matrix.arch}}.img
      
      - name: Determine release name
        id: release
        run: |
          if [ "${{ github.ref_type }}" = "tag" ]; then
            echo "name=${{ github.ref_name }}" >> $GITHUB_OUTPUT
            echo "tag=${{ github.ref_name }}" >> $GITHUB_OUTPUT
          else
            echo "name=${{ github.ref_name }}-continuous" >> $GITHUB_OUTPUT
            echo "tag=${{ github.ref_name }}-continuous" >> $GITHUB_OUTPUT
          fi

      - name: Create / Update Release and Upload Artifact
        uses: softprops/action-gh-release@v2
        with:
          name: ${{ steps.release.outputs.name }}
          tag_name: ${{ steps.release.outputs.tag }}
          prerelease: ${{ github.ref_type != 'tag' }}
          allowUpdates: true
          files: |
            _out/${{matrix.arch}}-linux-musl/images/avyos-${{matrix.arch}}.img.zst
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
