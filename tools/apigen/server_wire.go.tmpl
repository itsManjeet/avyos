// Code generated by apigen. DO NOT EDIT.

package {{.Package}}

import (
    "errors"
    "io"
    
    api "avyos.dev/api/{{.Spec.Object.Name | lower}}"
    "avyos.dev/pkg/connect"
)

var ErrUnknownEvent = errors.New("unknown event")

type {{.Spec.Object.Name}}Server struct {
    impl *{{.Spec.Object.Name}}
}


func start{{.Spec.Object.Name}}Server(impl *{{.Spec.Object.Name}}) error {
	conn, err := connect.SystemBus()
	if err != nil {
		return err
	}

    if err := conn.Register(api.ObjectId); err != nil {
		return err
	}

	s := &{{.Spec.Object.Name}}Server{impl: impl}
	
	for {
		m, err := conn.Recieve()
		if err != nil {
			if err == io.EOF {
				return nil
			}
			continue
		}
		out, err := s.Dispatch(m.Event, m.Payload)
		if err != nil {
			conn.Send(connect.Message{
				Sender: api.ObjectId,
				Destination: m.Sender,
				Event: connect.BusErrorEvent,
				Payload: []byte(err.Error()),
			})
			continue
		}

		conn.Send(connect.Message{
			Sender: api.ObjectId,
			Destination: m.Sender,
			Event: connect.BusReplyEvent,
			Payload: out,
		})
	}
}

func (s *{{.Spec.Object.Name}}Server) Dispatch(event uint16, payload []byte) ([]byte, error) {
	switch event {
	{{- range .Spec.Events}}
	case api.{{.Name}}Event:
		return s.handle{{.Name}}(payload)
	{{- end}}
	default:
		return nil, ErrUnknownEvent
	}
}

{{range .Spec.Events}}
func (s *{{$.Spec.Object.Name}}Server) handle{{.Name}}(payload []byte) ([]byte, error) {

	{{- if .Input.Type}}
	in, err := connect.Decode[{{.Input.Type}}](payload)
	if err != nil {
		return nil, err
	}

	out, err := s.impl.{{.Name}}(in)
	{{- else}}
	out, err := s.{{.Name}}()
	{{- end}}

	if err != nil {
		return nil, err
	}

	{{- if .Output.Type}}
	return connect.Encode(out)
	{{- else}}
	return nil, nil
	{{- end}}
}
{{end}}
